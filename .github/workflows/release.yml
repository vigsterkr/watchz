name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-linux-musl
            arch: amd64
          - target: aarch64-linux-musl
            arch: arm64
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      
      - name: Install LLVM
        run: sudo apt-get update && sudo apt-get install -y llvm

      - name: Build for ${{ matrix.arch }}
        run: |
          zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe
          llvm-strip zig-out/bin/watchz
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: watchz-linux-${{ matrix.arch }}
          path: zig-out/bin/watchz

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare binaries for release
        run: |
          mkdir -p release
          cp artifacts/watchz-linux-amd64/watchz release/watchz-linux-amd64
          cp artifacts/watchz-linux-arm64/watchz release/watchz-linux-arm64
          chmod +x release/*
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Docker Images
            
            Multi-arch image (supports amd64 and arm64):
            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ```
            
            Or use `latest`:
            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ```
            
            ## Standalone Binaries
            
            Download the appropriate binary for your platform from the assets below:
            - `watchz-linux-amd64` - For x86_64 Linux systems
            - `watchz-linux-arm64` - For ARM64 Linux systems
            
            Make it executable:
            ```bash
            chmod +x watchz-linux-*
            ./watchz-linux-amd64 --help
            ```
            
            ## Supported Platforms
            - `linux/amd64`
            - `linux/arm64`
          files: |
            release/watchz-linux-amd64
            release/watchz-linux-arm64
      
      - name: Install crane
        uses: imjasonh/setup-crane@v0.4
      
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin
      
      - name: Build and push OCI images
        run: |
          VERSION=${GITHUB_REF_NAME#v}  # Strip 'v' prefix: v0.1.0 -> 0.1.0
          
          # Build image for each architecture
          for arch in amd64 arm64; do
            echo "Building image for ${arch}..."
            
            # Create a minimal rootfs with just the binary
            mkdir -p rootfs
            cp artifacts/watchz-linux-${arch}/watchz rootfs/watchz
            chmod +x rootfs/watchz
            
            # Create a tarball for the new layer
            tar -C rootfs -cf layer.tar watchz
            
            # Append our binary layer to distroless base
            crane append \
              --base gcr.io/distroless/static-debian12:nonroot \
              --new_layer layer.tar \
              --new_tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${arch}
            
            echo "Pushed ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${arch}"
            
            # Cleanup
            rm -rf rootfs layer.tar
          done
          
          # Create multi-arch manifest
          echo "Creating multi-arch manifest..."
          crane index append \
            --manifest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-amd64 \
            --manifest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-arm64 \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}
          
          # Also tag as latest
          crane index append \
            --manifest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-amd64 \
            --manifest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-arm64 \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo "‚úÖ Release complete!"
          echo "üì¶ Standalone binaries: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "üê≥ Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
